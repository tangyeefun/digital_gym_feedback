<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>One Point Balance Trainer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0c0f; --card:#111319; --border:#1d2230; --muted:#a7afc0; --text:#e7e9ee;
      --primary:#3d7cff; --ok:#2cbb5d; --neutral:#444; --warn:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1000px;margin:0 auto;padding:24px 20px;}
    header h1{margin:0;font-size:28px;}
    header p{margin:6px 0 0;font-size:14px;color:var(--muted);}
    .layout{display:grid;grid-template-columns:1.2fr .8fr;gap:24px;}
    @media (max-width:980px){.layout{grid-template-columns:1fr;}}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:16px;
    }
    .stage{
      position:relative;
      width:100%;
      aspect-ratio:4/3;
      background:#000;
      border:1px solid #333;
      border-radius:12px;
      overflow:hidden;
    }
    #video,#canvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
    }
    #video{display:none;}
    .panel{
      padding:14px;
      border:1px dashed #333;
      border-radius:12px;
      margin-bottom:12px;
    }
    .panel h3{
      margin:0 0 6px;
      font-size:14px;
      text-transform:uppercase;
      color:var(--muted);
      letter-spacing:.04em;
    }
    #instructionText{font-size:26px;font-weight:700;line-height:1.35;}
    #feedbackText{
      font-size:32px;
      font-weight:800;
      color:var(--warn);
      text-align:center;
      min-height:1.2em;
      line-height:1.2;
    }
    #feedbackText small{
      display:block;
      font-size:20px;
      color:var(--ok);
      font-weight:600;
      margin-top:4px;
    }
    button{
      padding:10px 18px;
      font-size:16px;
      border:none;
      border-radius:8px;
      cursor:pointer;
    }
    #startButton{background:var(--primary);color:#fff;}
    #resetButton{background:var(--neutral);color:#fff;}
    #homeButton{background:var(--ok);color:#fff;}
    #strengthButton{background:#9254ff;color:#fff;}
    #canvas{
      transition: box-shadow .35s ease, border-color .35s ease;
      border:1px solid #333;
    }
    #canvas.success-glow{
      box-shadow: 0 0 40px 10px rgba(44,187,93,.8);
      border-color:#2cbb5d;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>One Point Balance Trainer</h1>
      <p>Hold each pose for 3 seconds. Stay still for best results.</p>
    </header>

    <main class="layout">
      <section class="card">
        <div class="stage">
          <video id="video" autoplay playsinline></video>
          <canvas id="canvas"></canvas>
        </div>
        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
          <button id="startButton">Start Exercise</button>
          <button id="resetButton">Reset</button>
          <a href="Index.html"><button id="homeButton">üè† Home</button></a>
          <a href="Strength Training.html"><button id="strengthButton">Strength Training</button></a>
        </div>
      </section>

      <aside class="card">
        <div class="panel">
          <h3>Instruction</h3>
          <p id="instructionText">Press <strong>Start</strong> to begin.</p>
        </div>
        <div class="panel">
          <h3>Feedback</h3>
          <p id="feedbackText"></p>
        </div>
      </aside>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <script>
    const video=document.getElementById('video');
    const canvas=document.getElementById('canvas');
    const ctx=canvas.getContext('2d');
    const startButton=document.getElementById('startButton');
    const resetButton=document.getElementById('resetButton');
    const instructionElement=document.getElementById('instructionText');
    const feedbackElement=document.getElementById('feedbackText');

    function setInstruction(msg){instructionElement.innerText=msg;}
    function setFeedback(msg){feedbackElement.innerHTML=msg;}

    function resizeCanvas(){
      const rect=canvas.parentElement.getBoundingClientRect();
      canvas.width=rect.width;canvas.height=rect.height;
    }
    window.addEventListener('resize',resizeCanvas);
    resizeCanvas();

    let stage='idle',startTime=null,camera=null,feedbackTimeout=null;
    let inabilityStart=null,strengthMsgShown=false;

    const pose=new Pose({locateFile:(f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`});
    pose.setOptions({modelComplexity:1,smoothLandmarks:true,minDetectionConfidence:0.5,minTrackingConfidence:0.5});

    function timeHeld(sec){if(!startTime)startTime=Date.now();return (Date.now()-startTime)/1000>=sec;}
    function resetTimer(){startTime=null;}

    function detectOneLegBalance(lm){
      const LAnk=lm[27],RAnk=lm[28],LKnee=lm[25],RKnee=lm[26],LFoot=lm[31],RFoot=lm[32];
      if(!(LAnk&&RAnk))return false;
      const VERT=0.08,KNEE=0.06;
      const fd=(LFoot&&RFoot)?Math.abs(LFoot.y-RFoot.y):0;
      const ad=Math.abs(LAnk.y-RAnk.y);
      const kd=(LKnee&&RKnee)?Math.abs(LKnee.y-RKnee.y):0;
      return (fd>VERT)||(ad>VERT)||(kd>KNEE);
    }

    function detectStillness(lm){
      if(!detectStillness.prev){
        detectStillness.prev=lm.map(l=>({x:l.x,y:l.y}));
        return true;
      }
      let move=0;
      for(let i=0;i<lm.length;i++){
        const dx=lm[i].x-detectStillness.prev[i].x;
        const dy=lm[i].y-detectStillness.prev[i].y;
        move+=Math.sqrt(dx*dx+dy*dy);
      }
      detectStillness.prev=lm.map(l=>({x:l.x,y:l.y}));
      return move<0.18;
    }

    let currentPose=1;
    const poses=[
      {text:"Pose 1: Balance on one leg for 3s. Any arms/leg position."},
      {text:"Pose 2: Balance on one leg for 3s ‚Äî make it DIFFERENT from Pose 1 (arms/leg anywhere)."},
      {text:"Pose 3: Balance on one leg for 3s ‚Äî make it DIFFERENT from Pose 1 & 2 (arms/leg anywhere)."}
    ];

    pose.onResults(res=>{
      if(stage==='pause'||stage==='done'){
        if(res.image){ctx.clearRect(0,0,canvas.width,canvas.height);ctx.drawImage(res.image,0,0,canvas.width,canvas.height);}
        return;
      }
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if(res.image)ctx.drawImage(res.image,0,0,canvas.width,canvas.height);
      if(!res.poseLandmarks){checkInabilityTimer();return;}
      const lm=res.poseLandmarks;
      drawConnectors(ctx,lm,POSE_CONNECTIONS,{lineWidth:2});
      drawLandmarks(ctx,lm,{radius:2});
      setInstruction(poses[currentPose-1].text);
      const inPose=detectOneLegBalance(lm);
      if(!inPose){resetTimer();setFeedback('');checkInabilityTimer();return;}
      const still=detectStillness(lm);
      if(!still){
        setFeedback('Please try to stay still like a statue.<br><small>Look at an object in front of you.</small>');
        if(feedbackTimeout)clearTimeout(feedbackTimeout);
        feedbackTimeout=setTimeout(()=>setFeedback(''),1000);
        resetTimer();checkInabilityTimer();return;
      }
      if(timeHeld(3)){
        if(currentPose===1){
          setFeedback("Great body shape with good body control. Let‚Äôs perform another.");
          canvas.classList.add('success-glow');stage='pause';
          setTimeout(()=>{
            setFeedback("");canvas.classList.remove('success-glow');
            currentPose=2;resetTimer();setInstruction(poses[1].text);stage='freeze';
          },5000);
        }else if(currentPose===2){
          setFeedback("Nice variation. Let‚Äôs perform another.");
          canvas.classList.add('success-glow');stage='pause';
          setTimeout(()=>{
            setFeedback("");canvas.classList.remove('success-glow');
            currentPose=3;resetTimer();setInstruction(poses[2].text);stage='freeze';
          },5000);
        }else{
          setFeedback("Perfect! You did well with body control and variation.");
          canvas.classList.add('success-glow');stage='pause';
          setTimeout(()=>{
            setFeedback("");canvas.classList.remove('success-glow');
            setInstruction("All one point balances complete!");stage='done';
          },5000);
        }
      }else{checkInabilityTimer();}
    });

    function checkInabilityTimer(){
      if(strengthMsgShown||stage==='idle'||stage==='done'||currentPose!==1)return;
      if(!inabilityStart)return;
      const elapsed=(Date.now()-inabilityStart)/1000;
      if(elapsed>=60){
        setFeedback('Try doing some strength training. Click on the "Strength Training" button on the left to learn how!');
        strengthMsgShown=true;
      }
    }

    async function startTracking(){
      startButton.disabled=true;startButton.textContent='Starting‚Ä¶';resizeCanvas();
      const camOpts={onFrame:async()=>{await pose.send({image:video});},width:960,height:720};
      camera=new Camera(video,camOpts);camera.start();
      stage='freeze';currentPose=1;resetTimer();setInstruction(poses[0].text);
      inabilityStart=Date.now();strengthMsgShown=false;
      startButton.textContent='Running';setTimeout(()=>{startButton.disabled=false;},600);
    }

    function stopCamera(){
      if(video.srcObject){video.srcObject.getTracks().forEach(t=>t.stop());video.srcObject=null;}
      if(camera&&camera.stop){try{camera.stop();}catch(e){}camera=null;}
    }

    startButton.addEventListener('click',startTracking);
    resetButton.addEventListener('click',()=>{
      setInstruction('Press Start to begin.');setFeedback('');
      stage='idle';resetTimer();stopCamera();
      canvas.classList.remove('success-glow');
      detectStillness.prev=null;inabilityStart=null;strengthMsgShown=false;
    });
  </script>
</body>
</html>
